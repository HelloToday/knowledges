### 1. 校验工单状态

#### 	1.1 查询工单

​		

```sql
SELECT * from t_lon_application t  where t.APP_ID =?
```

查询工单是否是出于F0220（待签合同的状态）

校验t.channelId是否为空

### 2. 初始化参数

入参是 1中查询出来的实体类 t

#### 2.1  检验申请金额是否为空（t.appayAmt）

申请金额为空的时候替换为t.approveAmt（审批金额）

#### 	2.2 检验合同编号

​	

```sql
### 查询序列号
SELECT SEQ_NO+1 AS NEXT_VAL FROM T_SYS_CONTRACT_CODE t where SALE_CHANNEL=1

###利用数据库里面的值保存了当前最新的数值
select * from T_SYS_CONTRACT_CODE

```

​	如果为空则生成 编号 渠道id+日期（精确到天如：20160304）+6位顺序号递增（这个方法锁的范围太大了，有没有并发问题，另外魔术值尽量用枚举，另外生成合同编号的逻辑考虑可以考虑优化）

​	**t_lon_application 持久化合同号到这个表里面**

#### 2.3 查询扩展表

​	

```sql
SELECT * from  t_lon_application_ext t where t.APP_ID=?
```

1. 获取什么信息？

#### 2.4 dubbo调用贷前服务

联系人表，汽车，房产，房抵信息

#### 2.5 账户信息(银行卡信息)

```sql
####这个表连存的是银行卡和个人信息
select * from t_lon_account where APP_ID = #{appId} and VALID = 1
```



#### 2.6 设置费用信息

```sql
   select  *  from t_loan_fee_info    where APP_ID = #{appId} 
```

​	

#### 2.7 试算步骤

1. 获取分期费用
2. 获取还款计划列表

### 3  构建扩展参数

1. 查询银行卡信息

```sql
####这个表连存的是银行卡和个人信息 
####appId={appId}, accType="B6801", trusteeType="B134003" 还款实体卡
####appId, "B6802", "B134003"放款实体卡
select * from t_lon_account where APP_ID = #{appId} and VALID = 1 and appId={appId}, and  accType="B6801" and trusteeType="B134003"
```

2. 被保险人信息（机构）

   缓存查询资金渠道信息"BASE.T_FUND_CHANNEL_CONFIG."+channelId

### 4. 构建关联关系

#### 4.1 非P2P对应的关系

 "CLC01","PC01","CCA01","ECBS01"

#### 4.2获取配置模板

 