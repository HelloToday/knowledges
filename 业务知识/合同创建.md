## 轮廓

### 公用：

所有的代码都会实现一个接口IntfServer，里面一个invoke方法，入参是JsonNode

invoke方法会一次执行实现方法里面的init ,validate方法。



### 创建合同

#### 1. 校验工单状态

* createLog.getProcsSts().equals("AE01") 进行解析扩展信息的操作
  * 逻辑如下如果createLog的属性extroInfo（他有两个属性一个是extroOther，feeList）非空，则将其属性组织成列表的形式插入到t_mls_loan_create_log_extro这个表里面；
  * t_mls_loan_create_log 里面的状态更新到 LS02
  * **手动处理事务隔离级别的时候建议用枚举**

* LS02 手动获取工单的保障信息

  * 调保险服务查询保险和信用管理费信息  批量插入到t_mls_loan_safeguard_info这个表里面

  * 更新t_mls_loan_create_log 里面的状态更新到 CA01

* CA01工单金额计算

  * 计算合同金额及保存费用 ，按照appId从t_lon_application查询记录

  * 从extroInfo（他有两个属性一个是extroOther，feeList）里面获取外部费率信息和费用信息

  * 还款计划接口，取data里面feeInfoList节点加入到费用列表当中，取工单信息里面的tLoanFeeInfolist节点

  * 校验上述的费用信息，其实就是做了个非空非0的校验

  * 手动开启事务 保存工单金额 到 insert into t_loan_fee_info 然后

  * 更新t_mls_bill_info 费用信息

  * 更新工单表 费用信息

  * 提交事务 设置状态为AR01

* AR01更新仲裁信息

  * 缓存当中取产品信息
  * appId 取工单信息
  * 查询仲裁信息,更新到工单表
  * 更新状态到IS02

* IS02初始化工单流程状态

  *  根据产品编号获取初始化工单 流程状态


```sql
SELECT
		t.NEXT_STATUS
	FROM
		t_mls_product_process_status t
	WHERE
	t.PRODUCT_ID = #{productId,jdbcType=VARCHAR} and t.IND_VALID = 'Y'
```

* * 更新状态到出事状态
  * 工单状态设置后续处理
  * t_loan_match_task_create_log 插入批量
  * 更新流程表的状态"procsSts","E","transSts","S"

#### 2 初始化参数

* GeneratateContractID 生成合同编号 这个方法里面写了sql有 sql 注入的风险
* 保存合同编号到工单表里面T_LON_APPLICATION
* 联系人列表  联系人列表 房抵信息 账户信息（t_lon_account这个表）
*  费用信息查询t_loan_fee_info ，设置到属性tLoanFeeInfolist里面
* 试算产品（1009排除之外）设置还款计划和费用

#### 3. 构建附加信息（生成合同作为参数传入）

* buildExtroPara 构建参数  得到还款实体卡和放款实体卡（t_lon_account）,缓存差机构信息 
* * 

#### 4.构建合同对应关系

##### p2p

直接用appId查询t_lon_contact表

##### 非P2P

调用四个方法

CLC01","PC01","CCA01","ECBS01 就会生成几个模板对应关系（）

- 渠道借款类合同生成所需配置

- 公用合同生成所需配置

- 渠道征信授权书生成

- 其它类型合同生成(担保)

  CCA01 CLC01 ECBS01这三个类型获的需要查询如下操作

  * 查询所有的模板信息
  * 根据产品ID和渠道找到映射的 模板编号

- 查询工单保障信息（根据appId）来自t_mls_loan_safeguard_info表

- select * from t_lon_application_contract 工单和合同对应表

- 查询 待生成合同的合同记录

#### 5.生成合同

* 根据工单号 ，模板号 生成文件存储路径（临时目录）
* 根据合同模板号（合同模板UUID）将html下载到本地
* 上传合同（返回文件存储的路径）
* 修改工单状态

##### 3.1 解析模板 --函数

参数规格${B12303_currentYear} 占位符里面包括两部分，一个是数据的取值方式，一个是数据的来源以及格式

1. 工单属性是一个列表，计算（字符截取处理，定长处理），筛选，格式处理
2. 根据传入参数获取属性值，根据这个值取查询别的参数
3. 内容填充 

B12303_contractAmtFixedLength30@B12307_30

##### 3.2 定值查询

 @符号分割，_下划线做属性和格式分割

1. 超能合同模板需要调用贷前的接口
2. 根据工单ID调用贷前接口，获取商品信息
3. 合同参数不为空的时候 查询合同信息

##### 3.3标准码

 	1. 反射取到模板里面设置的参数值；
 	2. 根据标准代码类型和标准代码查找对应的中文名称比如 companyType
 	3. 从内存当中取值

##### 3.4 费用转大写 

​	${B12305_firstStageRepayAmt_B12403}

 	配置信息：以下划线分割，第一位是key,第二位是字段名字，第三位是取值方式

##### 3.5 百分比取值（配置当中不存在）

#### 6.生成PDF文件

使用模板,模板数据,生成pdf， 查询接口url

#### 7. 上传合同

#### 8. 修改工单的状态























//todo 缓存信息获取