http://www.cnblogs.com/z-3FENG/p/9603294.html
http://www.cnblogs.com/kismetv/p/9236731.html(主从复制原理)

Redis读写分离架构

### 主要解决那些问题？
在Redis的持久化中曾提到，Redis高可用的方案包括持久化、
主从复制（及读写分离）、哨兵和集群。

* 其中持久化侧重解决的是Redis数据的单机备份问题（从内存到硬盘的备份）；
* 而主从复制则侧重解决数据的多机热备。此外，主从复制还可以实现负载均衡和故障恢复。


### 如何建立主从关系？

slaveof none --断开连接
slaveof ip:port 给一个slave指定相应的master

### 主从复制的几个阶段？

主从复制过程大体可以分为3个阶段：连接建立阶段（即准备阶段）、
数据同步阶段、命令传播阶段



### 数据同步阶段的全量复制和部分复制？

* 全量复制：用于初次复制或其他无法进行部分复制的情况，
将主节点中的所有数据都发送给从节点，是一个非常重型的操作。

* 部分复制：用于网络中断等情况后的复制，
只将中断期间主节点执行的写命令发送给从节点，
与全量复制相比更加高效。需要注意的是，如果网络中断时间过长，
导致主节点没有能够完整地保存中断期间执行的写命令，
则无法进行部分复制，仍使用全量复制。

**这个部分复制和我理解的部分复制的意义相差很大：我意识形态里面
的部分复制其实是增量复制的意思，和redis里面这个大相径庭**


### 为什么说全量复制是重型的操作？
答：
* 主节点通过bgsave命令fork子进程进行RDB持久化，该过程是非常消耗CPU、内存(页表复制)、硬盘IO的；关于bgsave的性能问题

* 主节点通过网络将RDB文件发送给从节点，对主从节点的带宽都会带来很大的消耗

* 从节点清空老数据、载入新RDB文件的过程是阻塞的，
无法响应客户端的命令；如果从节点执行bgrewriteaof，
也会带来额外的消耗 


### 各种场景下的肤质选择以及优化技巧

* （1）第一次建立复制
此时全量复制不可避免，但仍有几点需要注意：
如果主节点的数据量较大，应该尽量避开流量的高峰期，
避免造成阻塞；如果有多个从节点需要建立对主节点的复制，
可以考虑将几个从节点错开，避免主节点带宽占用过大。
此外，如果从节点过多，也可以调整主从复制的拓扑结构，
由一主多从结构变为树状结构（中间的节点既是其主节点的从节点，也是其从节点的主节点）；
但使用树状结构应该谨慎：虽然主节点的直接从节点减少，降低了主节点的负担，
但是多层从节点的延迟增大，数据一致性变差；且结构复杂，维护相当困难。



* （2）主节点重启
主节点重启可以分为两种情况来讨论，一种是故障导致宕机，另一种则是有计划的重启。

**主节点宕机**

主节点宕机重启后，runid会发生变化，因此不能进行部分复制，只能全量复制。

实际上在主节点宕机的情况下，应进行故障转移处理，
将其中的一个从节点升级为主节点，其他从节点从新的主节点进行复制；
且故障转移应尽量的自动化，后面文章将要介绍的哨兵便可以进行自动的故障转移。

_所以其实是有优化的点的，哨兵模式解决了朱聪的故障切换的过程_


安全重启：debug reload

在一些场景下，可能希望对主节点进行重启，例如主节点内存碎片率过高，或者希望调整一些只能在启动时调整的参数。
如果使用普通的手段重启主节点，会使得runid发生变化，可能导致不必要的全量复制。

为了解决这个问题，Redis提供了debug reload的重启方式：重启后，主节点的runid和offset都不受影响，避免了全量复制。

如下图所示，debug reload重启后runid和offset都未受影响：



但debug reload是一柄双刃剑：它会清空当前内存中的数据，重新从RDB文件中加载，这个过程会导致主节点的阻塞，因此也需要谨慎。

* （3）从节点重启
从节点宕机重启后，其保存的主节点的runid会丢失，
因此即使再次执行slaveof，也无法进行部分复制。

**到这里位置 我已近刚看到了好几个runId了，所以什么是runId呢**

（4）网络中断
如果主从节点之间出现网络问题，造成短时间内网络中断，可以分为多种情况讨论。

第一种情况：网络问题时间极为短暂，只造成了短暂的丢包，主从节点都没有判定超时（未触发repl-timeout）；此时只需要通过REPLCONF ACK来补充丢失的数据即可。

第二种情况：网络问题时间很长，主从节点判断超时（触发了repl-timeout），且丢失的数据过多，超过了复制积压缓冲区所能存储的范围；此时主从节点无法进行部分复制，只能进行全量复制。为了尽可能避免这种情况的发生，应该根据实际情况适当调整复制积压缓冲区的大小；此外及时发现并修复网络中断，也可以减少全量复制。

第三种情况：介于前述两种情况之间，主从节点判断超时，且丢失的数据仍然都在复制积压缓冲区中；此时主从节点可以进行部分复制。




#### 总结

1、主从复制的作用：宏观的了解主从复制是为了解决什么样的问题，
即数据冗余、故障恢复、读负载均衡等。

2、主从复制的操作：即slaveof命令。

3、主从复制的原理：主从复制包括了连接建立阶段、数据同步阶段、命令传播阶段；
其中数据同步阶段，有全量复制和部分复制两种数据同步方式；
命令传播阶段，主从节点之间有PING和REPLCONF ACK命令互相进行心跳检测。

4、应用中的问题：包括读写分离的问题（数据不一致问题、数据过期问题、故障切换问题等）
、复制超时问题、复制中断问题等，然后总结了主从复制相关的配置，
其中repl-timeout、client-output-buffer-limit slave
等对解决Redis主从复制中出现的问题可能会有帮助。

主从复制虽然解决或缓解了数据冗余、故障恢复、读负载均衡等问题，
但其缺陷仍很明显：故障恢复无法自动化；写操作无法负载均衡；存储能力受到单机的限制；
这些问题的解决，需要哨兵和集群的帮助，我将在后面的文章中介绍，欢迎关注。 


